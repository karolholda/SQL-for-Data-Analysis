-- Modul 8.1 WITH CTE AS (…)

/*
8.1 Składnia CTE

CTE (Common Table Expression) to tymczasowy wynik zapytania, któremu nadawana jest nazwa i można go użyć jak tabeli.
	• CTE działa tylko w jednym zapytaniu – nie zapisuje się na stałe,
	• pozwala pisać czytelniejsze i podzielone na kroki zapytania,
	• zastępuje podzapytania w FROM,
	• może być rekurencyjne (dla struktur hierarchicznych, np. drzewa kategorii).

Składnia
WITH NazwaCTE AS (
    SELECT ...  -- zapytanie bazowe
)

SELECT ...
FROM NazwaCTE
WHERE ...;


Lista Produktów zamówionych więcej niż 200 razy
Krok po kroku:
1. CTE (WITH Top_Produkty_CTE AS (...)):
	• Grupuje dane w tabeli Zamowione_Produkty.
	• Dla każdego Produkt_ID liczy, ile razy został zamówiony (COUNT(Zamowienie_ID)).
		
2. W głównym zapytaniu SELECT:
	• Pobiera tylko te produkty, które miały więcej niż 200 zamówień.
*/
WITH Top_Produkty_CTE AS (
    SELECT 
          Produkt_ID
        , COUNT(Zamowienie_ID) AS Liczba_Zamowien
    FROM Zamowione_Produkty
    GROUP BY Produkt_ID
)

SELECT * 
FROM Top_Produkty_CTE
WHERE Liczba_Zamowien > 200;


/* Klienci z więcej niż 100 zamówieniami
Krok po kroku:
1. CTE (WITH Klienci_Z_Liczba_Zamowien_CTE AS (...)):
	• Dołącza klientów do zamówień,
	• Grupuje po Klient_ID, Imie, Nazwisko,
	• Zlicza liczbę zamówień przypisanych do każdego klienta.
2. W głównym zapytaniu SELECT:
	• Filtruje tylko tych klientów, którzy mają więcej niż 100 zamówień.
*/
WITH Klienci_Z_Liczba_Zamowien_CTE AS (
    SELECT 
          k.Klient_ID
        , k.Imie
        , k.Nazwisko
        , COUNT(z.Zamowienie_ID) AS Liczba_Zamowien
    FROM Klienci k
    INNER JOIN Zamowienia z ON K.Klient_ID = z.Klient_ID
    GROUP BY k.Klient_ID, k.Imie, k.Nazwisko
)
SELECT *
FROM Klienci_Z_Liczba_Zamowien_CTE
WHERE Liczba_Zamowien > 100;


/*
Zagnieżdżanie CTE

Składnia
WITH A AS (...),
     B AS (SELECT * FROM A WHERE ...),
     C AS (SELECT * FROM B JOIN InnaTabela ...)
SELECT * FROM C;


Znajdź klientów, którzy w 2025 roku:
	• złożyli co najmniej 5 zamówień,
	• łącznie zamówili produkty o wartości przekraczającej 10 000 zł (wartość = Cena_Sprzedazy * Ilosc). 

Krok po kroku:
1. CTE Liczba_Zamowien_CTE
	• Liczy liczbę zamówień na klienta w 2025 roku
2. CTE Wartosc_Zamowien_CTE
	• Sumuje wartość zamówień klienta w 2025 roku (Cena_Sprzedazy * Ilosc)
3. W głównym zapytaniu SELECT:
	• Łączone są dwa CTE z tabelą Klienci
    • Filtruje klientów spełniających oba warunki: lz.Liczba_Zamowien >= 5 AND wz.Laczna_Wartosc > 10000
*/
WITH Liczba_Zamowien_CTE AS (
    SELECT 
         z.Klient_ID
        ,COUNT(DISTINCT z.Zamowienie_ID) AS Liczba_Zamowien
    FROM Zamowienia z
    WHERE YEAR(z.Data_Zlozenia_Zamowienia) = 2025
    GROUP BY z.Klient_ID
),

Wartosc_Zamowien_CTE AS (
    SELECT 
         z.Klient_ID
        ,SUM(zp.Cena_Sprzedazy * zp.Ilosc) AS Laczna_Wartosc
    FROM Zamowienia z
    INNER JOIN Zamowione_Produkty zp ON z.Zamowienie_ID = zp.Zamowienie_ID
    WHERE YEAR(z.Data_Zlozenia_Zamowienia) = 2025
    GROUP BY z.Klient_ID
)

SELECT 
     k.Klient_ID
    ,k.Imie
    ,k.Nazwisko
    ,lz.Liczba_Zamowien
    ,wz.Laczna_Wartosc
FROM Liczba_Zamowien_CTE lz
INNER JOIN Wartosc_Zamowien_CTE wz ON lz.Klient_ID = wz.Klient_ID
INNER JOIN Klienci k ON k.Klient_ID = lz.Klient_ID
WHERE 
    lz.Liczba_Zamowien >= 5
    AND wz.Laczna_Wartosc > 10000
ORDER BY wz.Laczna_Wartosc DESC;


/*
CTE rekurencyjne – do hierarchii (np. Pracownik - Kierownik)

Krok po kroku:
CTE (Common Table Expression) WITH Hierarchia_Organizacyjna_CTE AS (...) tworzy wirtualną tabelę, 
w której budowana jest struktura firmy,
1. Pierwszy SELECT (kotwica, root)
	• Wybieramy pracowników bez przełożonego (Kierownik_ID IS NULL),
	• To zwykle właściciel firmy lub najwyższe stanowisko,
	• Nadajemy Poziom = 0,
2. Drugi SELECT (rekurencja)
	• Znajduje pracowników, którzy mają przełożonego — takiego, który już zo(stał znaleziony w poprzednim kroku,
	• Do każdego takiego pracownika przypisywany jest Poziom = h.Poziom + 1,
	• Z każdym kolejnym poziomiem/iteracją h.Poziom jest zwiekszany o +1,
3. Całość łączy UNION ALL, co oznacza, że z wyników nie są usuwane duplikaty — wymagane w hierarchicznym CTE,
4. Wynik końcowy pokazuje pracowników posortowanych według poziomu i przełożonego.
*/
WITH Hierarchia_Organizacyjna_CTE AS (
    -- [1] Poziom 0: pracownicy bez przełożonego (np. właściciel firmy)
    SELECT 
         Pracownik_ID 
        ,Imie
        ,Rola
        ,Kierownik_ID
        ,0 AS Poziom
    FROM Pracownicy
    WHERE Kierownik_ID IS NULL

    UNION ALL  -- [3] połączenie wyników

    -- [2] Rekurencyjnie dodawani są kolejni pracownicy (kolejne poziomy: osoby podległe)
    SELECT 
         p.Pracownik_ID
        ,p.Imie
        ,p.Rola
        ,p.Kierownik_ID
        ,h.Poziom + 1 AS Poziom
    FROM Pracownicy p
    INNER JOIN Hierarchia_Organizacyjna_CTE h ON p.Kierownik_ID = h.Pracownik_ID
)

-- [5] Ostateczny wynik
SELECT * 
FROM Hierarchia_Organizacyjna_CTE
ORDER BY Poziom, Kierownik_ID;



/*
CTE rekurencyjne – do hierarchii (np. Pracownik - Kierownik)

Rozszerzenie o ścieżkę raportowania (Sciezka_Raportowania)

Krok po kroku:
1. Początek taki sam jak wcześniej — od pracowników bez przełożonego (Kierownik_ID IS NULL).
2. Dodanie nowej kolumny Sciezka_Raportowania:
	• W pierwszym kroku (Poziom 0) jest to po prostu Imie.
	• W kolejnych krokach dobudowywana jest ścieżka hierarchiczna: 
        h.Sciezka_Raportowania + ' > ' + p.Imie
        Czyli: np. Imie Właściciela firmy > Imie Dyrektora > Imie Kierownika > Imie Pracownika,
3. CAST(... AS NVARCHAR(MAX)) służy temu, aby SQL Server nie ucinał długich tekstów
	• domyślnie Imie może być np. NVARCHAR(50), co przełożyło by się na kolumnę Sciezka_Raportowania,
4. Wynik końcowy pokazuje:
	• identyfikator pracownika,
	• jego imię,
	• poziom w hierarchii,
	• oraz pełną ścieżkę raportowania. 
*/
WITH Hierarchia_Organizacyjna_CTE AS (
    -- [1] Poziom 0: pracownicy bez przełożonego (np. właściciel firmy)
    SELECT 
         Pracownik_ID
        ,Imie
        ,Kierownik_ID
        ,0 AS Poziom
        ,CAST(Imie AS NVARCHAR(MAX)) AS Sciezka_Raportowania
    FROM Pracownicy
    WHERE Kierownik_ID IS NULL

    UNION ALL  -- [3] połączenie wyników

    -- [2] Rekurencyjnie dodawani są kolejni pracownicy (kolejne poziomy: osoby podległe)
    SELECT 
         p.Pracownik_ID
        ,p.Imie
        ,p.Kierownik_ID
        ,h.Poziom + 1 AS Poziom
        ,CAST(h.Sciezka_Raportowania + ' > ' + p.Imie AS NVARCHAR(MAX)) AS Sciezka_Raportowania
    FROM Pracownicy p
    INNER JOIN Hierarchia_Organizacyjna_CTE h ON p.Kierownik_ID = h.Pracownik_ID
)

-- [4] Ostateczny wynik
SELECT 
     Pracownik_ID
    ,Imie
    ,Kierownik_ID
    ,Poziom
    ,Sciezka_Raportowania
FROM Hierarchia_Organizacyjna_CTE
ORDER BY 
     Poziom
    ,Sciezka_Raportowania;
